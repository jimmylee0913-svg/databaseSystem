<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>☕ 後台管理系統 - 訂單清單</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">所有訂單列表</h1>
            
            <button id="clear-orders-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                清空所有訂單並重設編號
            </button>
        </div>
        
        <div class="bg-white shadow-xl rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂單 ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂單內容摘要</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總金額</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">取餐方式</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">外送地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂購人/聯絡人</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">手機後三碼</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
            <p id="loading-status" class="p-6 text-center text-gray-500">正在載入訂單...</p>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api/orders/all';
        const CLEAR_API_URL = 'http://127.0.0.1:5000/api/orders/clear';
        const tableBody = document.getElementById('orders-table-body');
        const loadingStatus = document.getElementById('loading-status');
        const clearOrdersBtn = document.getElementById('clear-orders-btn');

        function fetchOrders() {
            loadingStatus.textContent = '正在載入訂單...';
            loadingStatus.classList.remove('hidden');
            
            fetch(API_URL)
                .then(response => response.json())
                .then(orders => {
                    loadingStatus.classList.add('hidden');
                    if (orders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">目前沒有任何訂單。</td></tr>'; // colspan 改為 8
                        return;
                    }
                    
                    tableBody.innerHTML = '';
                    orders.forEach(order => {
                        const statusClass = order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                        
                        // 處理取餐方式顯示
                        let pickupTypeText = '';
                        let pickupTypeClass = 'bg-gray-100 text-gray-800';
                        if (order.pickup_type === 'delivery') {
                            pickupTypeText = '外送';
                            pickupTypeClass = 'bg-red-100 text-red-800';
                        } else {
                            pickupTypeText = '現場取餐';
                            pickupTypeClass = 'bg-blue-100 text-blue-800';
                        }

                        // VVVV 處理外送地址顯示 VVVV
                        const addressContent = order.pickup_type === 'delivery' && order.delivery_address 
                            ? `<span class="text-sm text-gray-900">${order.delivery_address}</span>` 
                            : '—'; 
                        // ^^^^ 處理外送地址顯示 ^^^^


                        const row = `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">${order.order_id}</td>
            <td class="px-6 py-4 whitespace-normal text-sm text-gray-900 max-w-xs">${order.content}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right">$${order.final_amount.toFixed(0)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${pickupTypeClass}">
                    ${pickupTypeText}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-normal max-w-xs">${addressContent}</td>
            <td class="px-6 py-4 whitespace-nowrap">${order.customer_name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${order.contact_phone_last_three}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                    ${order.status}
                </span>
            </td>
        </tr>
    `;
                        tableBody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                    loadingStatus.textContent = '載入訂單失敗，請檢查後端服務是否運行。';
                    loadingStatus.classList.remove('hidden');
                });
        }
        
        function handleClearOrders() {
            if (!confirm('警告：確定要清空所有訂單並重設訂單編號嗎？此操作無法恢復！')) {
                return;
            }

            // 禁用按鈕防止重複點擊
            clearOrdersBtn.disabled = true;
            clearOrdersBtn.textContent = '正在清空...';

            fetch(CLEAR_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                // 成功後重新載入訂單列表
                fetchOrders(); 
            })
            .catch(error => {
                console.error('清空訂單失敗:', error);
                alert('清空訂單失敗，請檢查網路或後端服務。');
            })
            .finally(() => {
                clearOrdersBtn.disabled = false;
                clearOrdersBtn.textContent = '清空所有訂單並重設編號';
            });
        }

        // 首次載入時抓取訂單
        fetchOrders();

        // 綁定清空按鈕事件
        clearOrdersBtn.addEventListener('click', handleClearOrders);

    </script>
</body>
</html>