<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° çµå¸³é é¢ - Bubble Tea King</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">

    <header class="bg-white shadow-md p-4">
        <div class="max-w-4xl mx-auto flex items-center">
            <a href="index.html" class="text-pink-600 hover:text-pink-700 text-lg mr-4">â† è¿”å›èœå–®</a>
            <h1 class="text-2xl font-bold text-gray-800">çµå¸³</h1>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 pt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-8">

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ğŸ“¦ æ‚¨çš„è¨‚å–®æ‘˜è¦</h2>
                <div id="order-summary-list" class="space-y-3">
                    <p class="text-gray-500">æ­£åœ¨è¼‰å…¥è³¼ç‰©è»Š...</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ğŸ“ å–é¤æ–¹å¼</h2>
                <div class="flex space-x-4 mb-4" id="pickup-options">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="pickup_type" value="pickup" checked class="form-radio text-pink-600">
                        <span>ç¾å ´å–é¤ (ç´„ 15 åˆ†é˜)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="pickup_type" value="delivery" class="form-radio text-pink-600">
                        <span>å¤–é€ (é‹è²» $50)</span>
                    </label>
                </div>

                <form id="checkout-form">
                    <div id="pickup-form" class="space-y-4">
                        <input type="text" id="contact-name" placeholder="å–é¤äººå§“å" class="w-full p-3 border rounded-lg focus:border-pink-500" required>
                        <input type="tel" id="contact-phone" placeholder="è¯çµ¡é›»è©±å¾Œä¸‰ç¢¼" class="w-full p-3 border rounded-lg focus:border-pink-500" required maxlength="3" pattern="\d{3}" inputmode="numeric">
                    </div>
                    <div id="delivery-form" class="space-y-4 hidden mt-4">
                        <input type="text" id="delivery-address" placeholder="å¤–é€åœ°å€" class="w-full p-3 border rounded-lg focus:border-pink-500">
                        <input type="text" placeholder="å‚™è¨» (å¦‚ï¼šè«‹å‹¿æŒ‰é–€éˆ´)" class="w-full p-3 border rounded-lg focus:border-pink-500">
                    </div>
                
                    <div class="bg-white p-6 rounded-xl shadow-lg mt-8 -mx-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ğŸ’³ ä»˜æ¬¾æ–¹å¼</h2>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-2 bg-gray-100 p-3 rounded-lg">
                                <input type="radio" name="payment_type" value="cash" checked class="form-radio text-pink-600">
                                <span>ç¾é‡‘æ”¯ä»˜ (ç¾å ´ä»˜æ¬¾)</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 p-3 rounded-lg">
                                <input type="radio" name="payment_type" value="credit" class="form-radio text-pink-600">
                                <span>ä¿¡ç”¨å¡ (ç·šä¸Šä»˜æ¬¾)</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 p-3 rounded-lg">
                                <input type="radio" name="payment_type" value="linepay" class="form-radio text-pink-600">
                                <span>Line Pay</span>
                            </label>
                        </div>
                    </div>
                </form>

            </div>

        </div>

        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-2xl sticky top-20">
                <h2 class="text-xl font-bold mb-4 text-pink-600">ğŸ’¸ è¨‚å–®ç¸½è¨ˆ</h2>
                <div class="space-y-2 border-b pb-4 mb-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">å•†å“ç¸½é¡:</span>
                        <span id="subtotal" class="font-medium">$0</span>
                    </div>
                    <div class="flex justify-between" id="delivery-fee-row">
                        <span class="text-gray-600">é‹è²»:</span>
                        <span id="delivery-fee" class="font-medium text-red-500">$0</span>
                    </div>
                </div>
                <div class="flex justify-between text-2xl font-extrabold text-gray-800">
                    <span>æ‡‰ä»˜ç¸½é¡:</span>
                    <span id="final-total">$0</span>
                </div>
                
                <button type="submit" form="checkout-form" id="place-order-btn" class="mt-6 w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition duration-200">
                    ç¢ºèªé€å‡ºè¨‚å–®
                </button>
            </div>
        </div>

    </main>

    <script>
        // å…¨åŸŸè®Šæ•¸å®šç¾© (èˆ‡ DOMContentLoaded å…§éƒ¨å…±äº«)
        let currentCart = [];
        let subtotal = 0;
        let DELIVERY_FEE = 0; 
        const BASE_DELIVERY_FEE = 50; 
        const API_URL = 'http://127.0.0.1:5000/api/order';

        // --- å‡½å¼ï¼šæ›´æ–°ç¸½é‡‘é¡é¡¯ç¤º ---
        function updateTotals() {
            const subtotalElement = document.getElementById('subtotal');
            const deliveryFeeElement = document.getElementById('delivery-fee');
            const finalTotalElement = document.getElementById('final-total');

            subtotalElement.textContent = `$${subtotal}`;
            deliveryFeeElement.textContent = DELIVERY_FEE === 0 ? 'å…è²»' : `$${DELIVERY_FEE}`;
            finalTotalElement.textContent = `$${subtotal + DELIVERY_FEE}`;
            
            // å¦‚æœè³¼ç‰©è»Šç‚ºç©ºï¼Œç¦ç”¨æŒ‰éˆ•
            document.getElementById('place-order-btn').disabled = currentCart.length === 0;
        }

        // --- å‡½å¼ï¼šæ¸²æŸ“è¨‚å–®æ‘˜è¦ä¸¦è¨ˆç®—ç¸½é¡ ---
        function renderOrderSummary() {
            const summaryList = document.getElementById('order-summary-list');
            
            // 1. å¾ localStorage è®€å–è³¼ç‰©è»Š
            const cartJSON = localStorage.getItem('currentCart');
            currentCart = cartJSON ? JSON.parse(cartJSON) : [];

            summaryList.innerHTML = '';
            subtotal = 0;

            if (currentCart.length === 0) {
                summaryList.innerHTML = '<p class="text-red-500">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹è¿”å›èœå–®é é»é¤ï¼</p>';
            } else {
                // 2. è¨ˆç®—ç¸½é¡ä¸¦æ¸²æŸ“åˆ—è¡¨
                subtotal = currentCart.reduce((total, item) => total + (item.price * item.quantity), 0);
                
                currentCart.forEach(item => {
                    const itemElement = document.createElement('div');
                    // å°‡ item.id è³¦äºˆçµ¦è³‡æ–™å±¬æ€§ï¼Œä»¥ä¾¿åˆªé™¤æ™‚è­˜åˆ¥
                    itemElement.className = 'flex justify-between items-start border-b border-gray-100 pb-2 pt-2';
                    itemElement.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${item.name} x ${item.quantity}</p>
                            <p class="text-sm text-gray-500 ml-2">${item.options}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-medium">$${item.price * item.quantity}</span>
                            <button type="button" 
                                data-item-id="${item.id}"
                                class="delete-item-btn text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    summaryList.appendChild(itemElement);
                });
                
                // 3. ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
                document.querySelectorAll('.delete-item-btn').forEach(button => {
                    button.addEventListener('click', deleteCartItem);
                });
            }

            updateTotals(); // æ›´æ–°å³å´ç¸½é‡‘é¡
        }
        
        // --- å‡½å¼ï¼šè™•ç†åˆªé™¤å“é … ---
        function deleteCartItem(event) {
            // ç²å–è¦åˆªé™¤çš„å“é …çš„å”¯ä¸€ ID
            const itemIdToDelete = parseInt(event.currentTarget.getAttribute('data-item-id'));

            // 1. å¾ currentCart é™£åˆ—ä¸­éæ¿¾æ‰è©²å“é …
            const newCart = currentCart.filter(item => item.id !== itemIdToDelete);
            
            // 2. æ›´æ–° localStorage
            localStorage.setItem('currentCart', JSON.stringify(newCart));
            
            // 3. é‡æ–°æ¸²æŸ“é é¢
            renderOrderSummary();
        }


        // --- DOMContentLoaded ä¸»ç¨‹å¼ ---
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹æ¸²æŸ“
            renderOrderSummary();

            const pickupOptions = document.getElementById('pickup-options');
            const pickupForm = document.getElementById('pickup-form');
            const deliveryForm = document.getElementById('delivery-form');
            const deliveryFeeRow = document.getElementById('delivery-fee-row');


            pickupOptions.addEventListener('change', (event) => {
                const type = event.target.value;
                if (type === 'delivery') {
                    DELIVERY_FEE = BASE_DELIVERY_FEE;
                    deliveryForm.classList.remove('hidden');
                    pickupForm.classList.remove('hidden');
                    deliveryFeeRow.classList.remove('hidden');
                } else {
                    DELIVERY_FEE = 0;
                    deliveryForm.classList.add('hidden');
                    pickupForm.classList.remove('hidden');
                    deliveryFeeRow.classList.add('hidden');
                }
                updateTotals();
            });
            
            // åˆå§‹éš±è—é‹è²»
            document.getElementById('delivery-fee-row').classList.add('hidden'); 

            // --- è™•ç†é€å‡ºè¨‚å–® ---
            const checkoutForm = document.getElementById('checkout-form');
            const contactNameInput = document.getElementById('contact-name');
            const contactPhoneInput = document.getElementById('contact-phone');
            const deliveryAddressInput = document.getElementById('delivery-address');


            checkoutForm.addEventListener('submit', (event) => {
                event.preventDefault(); 

                const pickupType = document.querySelector('input[name="pickup_type"]:checked').value;
                let address = null; 
                
                // æª¢æŸ¥è³¼ç‰©è»Šæ˜¯å¦ç‚ºç©º
                if (currentCart.length === 0) {
                    alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•é€å‡ºè¨‚å–®ï¼');
                    return;
                }

                // åŸ·è¡Œå¿…å¡«æ¬„ä½å’Œæ ¼å¼æª¢æŸ¥ (å§“åå’Œé›»è©±åœ¨ HTML ä¸Šæœ‰ requiredï¼Œä½† JS ä»æª¢æŸ¥ä¸€æ¬¡)
                if (!contactNameInput.value) {
                    alert('è«‹å¡«å¯«å–é¤äººå§“åï¼');
                    contactNameInput.focus();
                    return;
                }
                // ... (é›»è©±é©—è­‰)

                // è™•ç†åœ°å€
                if (pickupType === 'delivery') {
                    address = deliveryAddressInput.value.trim(); 
                    if (!address) {
                        alert('æ‚¨é¸æ“‡äº†å¤–é€ï¼Œè«‹å¡«å¯«å¤–é€åœ°å€ï¼');
                        deliveryAddressInput.focus();
                        return;
                    }
                } else {
                    address = null; 
                }

                // æ”¶é›†è¨‚å–®è³‡æ–™
                const orderData = {
                    cartItems: currentCart, // ä½¿ç”¨æœ€æ–°çš„ currentCart
                    pickupType: pickupType,
                    paymentType: document.querySelector('input[name="payment_type"]:checked').value,
                    contactInfo: {
                        name: contactNameInput.value, 
                        phone: contactPhoneInput.value,
                        address: address 
                    } 
                };

                // ç™¼é€è¨‚å–®
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.order_id) {
                        alert(`è¨‚å–®é€å‡ºæˆåŠŸï¼æ‚¨çš„è¨‚å–®ç·¨è™Ÿæ˜¯ ${data.order_id}ï¼Œç¸½é‡‘é¡ $${data.final_amount}`);
                        localStorage.removeItem('currentCart');
                        window.location.href = `index.html`; 
                    } else {
                        // è™•ç†å¾Œç«¯å‚³å›çš„å¤±æ•—è¨Šæ¯
                        alert(`è¨‚å–®é€å‡ºå¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }
                })
                .catch((error) => {
                    console.error('Fetch Error:', error);
                    alert('ç¶²è·¯éŒ¯èª¤ï¼Œè¨‚å–®ç„¡æ³•é€å‡ºï¼è«‹æª¢æŸ¥ Console äº†è§£è©³æƒ…ã€‚');
                });
            });
        });
    </script>
</body>
</html>